d81ea6e6f28ad08e595c14665c7f08a9
var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _reduxSagaTestPlan = require("redux-saga-test-plan");

var _reactNative = require("react-native");

var _netinfo = _interopRequireDefault(require("@react-native-community/netinfo"));

var _sagas = _interopRequireWildcard(require("../redux/sagas"));

var _actionCreators = require("../redux/actionCreators");

var _createReducer = require("../redux/createReducer");

var _checkInternetAccess = _interopRequireDefault(require("../utils/checkInternetAccess"));

var _constants = require("../utils/constants");

var __assign = this && this.__assign || function () {
  __assign = Object.assign || function (t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];

      for (var p in s) {
        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
      }
    }

    return t;
  };

  return __assign.apply(this, arguments);
};

var __rest = this && this.__rest || function (s, e) {
  var t = {};

  for (var p in s) {
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];
  }

  if (s != null && typeof Object.getOwnPropertySymbols === "function") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];
  }
  return t;
};

var args = _constants.DEFAULT_ARGS;
describe('sagas', function () {
  describe('networkSaga', function () {
    it('forks netInfoChangeSaga with the right params', function () {
      var pingInterval = args.pingInterval,
          params = __rest(args, ["pingInterval"]);

      var pingInBackground = params.pingInBackground,
          pingOnlyIfOffline = params.pingOnlyIfOffline,
          rest = __rest(params, ["pingInBackground", "pingOnlyIfOffline"]);

      (0, _reduxSagaTestPlan.testSaga)(_sagas.default, params).next().fork(_sagas.netInfoChangeSaga, rest).next().isDone();
    });
    it("forks netInfoChangeSaga AND sets an interval \n    if pingInterval is higher than 0", function () {
      var pingInterval = args.pingInterval,
          params = __rest(args, ["pingInterval"]);

      var pingInBackground = params.pingInBackground,
          pingOnlyIfOffline = params.pingOnlyIfOffline,
          shouldPing = params.shouldPing,
          rest = __rest(params, ["pingInBackground", "pingOnlyIfOffline", "shouldPing"]);

      (0, _reduxSagaTestPlan.testSaga)(_sagas.default, __assign(__assign({}, args), {
        pingInterval: 3000
      })).next().fork(_sagas.netInfoChangeSaga, __assign(__assign({}, rest), {
        shouldPing: shouldPing
      })).next().fork(_sagas.connectionIntervalSaga, __assign(__assign({}, rest), {
        pingInterval: 3000,
        pingOnlyIfOffline: pingOnlyIfOffline,
        pingInBackground: pingInBackground
      })).next().isDone();
    });
    it('default parameters', function () {
      var pingOnlyIfOffline = args.pingOnlyIfOffline,
          pingInterval = args.pingInterval,
          pingInBackground = args.pingInBackground,
          params = __rest(args, ["pingOnlyIfOffline", "pingInterval", "pingInBackground"]);

      (0, _reduxSagaTestPlan.testSaga)(_sagas.default).next().fork(_sagas.netInfoChangeSaga, __assign({}, params)).next().isDone();
    });
  });
  describe('netInfoChangeSaga', function () {
    var params = {
      pingTimeout: args.pingTimeout,
      pingServerUrl: args.pingServerUrl,
      shouldPing: args.shouldPing,
      httpMethod: args.httpMethod,
      customHeaders: args.customHeaders
    };

    function channelLoop(saga) {
      return saga.next().call(_sagas.createNetInfoConnectionChangeChannel, _sagas.netInfoEventChannelFn).next('channel').take('channel').next(true).fork(_sagas.connectionHandler, __assign(__assign({}, params), {
        isConnected: true
      })).next().take('channel');
    }

    it('iOS', function () {
      _reactNative.Platform.OS = 'ios';
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.netInfoChangeSaga, params);
      channelLoop(saga);
    });
    it('Android', function () {
      _reactNative.Platform.OS = 'android';
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.netInfoChangeSaga, params).next().call([_netinfo.default, _netinfo.default.fetch]).next({
        isConnected: false
      }).fork(_sagas.connectionHandler, __assign(__assign({}, params), {
        isConnected: false
      }));
      channelLoop(saga);
    });
    it('closes the channel when it ends emitting', function () {
      _reactNative.Platform.OS = 'ios';
      var mockCloseFn = jest.fn();
      var mockChannel = {
        close: mockCloseFn
      };
      var iterator = (0, _sagas.netInfoChangeSaga)(params);
      iterator.next();
      iterator.next(mockChannel);

      try {
        iterator.next({
          isConnected: true
        });
        expect(mockCloseFn).toHaveBeenCalled();
      } catch (e) {}
    });
    it('does NOT close the channel if redux-saga does NOT yield a cancelled effect', function () {
      _reactNative.Platform.OS = 'ios';
      var mockCloseFn = jest.fn();
      var mockChannel = {
        close: mockCloseFn
      };
      var iterator = (0, _sagas.netInfoChangeSaga)(params);
      iterator.next();
      iterator.next(mockChannel);

      try {
        iterator.next({
          isConnected: false
        });
        expect(mockCloseFn).not.toHaveBeenCalled();
      } catch (e) {}
    });
  });
  describe('connectionHandler', function () {
    var params = {
      pingTimeout: args.pingTimeout,
      pingServerUrl: args.pingServerUrl,
      shouldPing: true,
      httpMethod: args.httpMethod,
      isConnected: true,
      customHeaders: args.customHeaders
    };
    it('forks checkInternetAccessSaga if shouldPing AND isConnected are true', function () {
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.connectionHandler, params);
      saga.next().fork(_sagas.checkInternetAccessSaga, {
        pingTimeout: args.pingTimeout,
        pingServerUrl: args.pingServerUrl,
        httpMethod: args.httpMethod,
        pingInBackground: args.pingInBackground,
        customHeaders: args.customHeaders
      }).next().isDone();
    });
    it('forks handleConnectivityChange if shouldPing OR isConnected are NOT true', function () {
      params.isConnected = false;
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.connectionHandler, params);
      saga.next().fork(_sagas.handleConnectivityChange, false).next().isDone();
    });
  });
  describe('connectionIntervalSaga', function () {
    var shouldPing = args.shouldPing,
        params = __rest(args, ["shouldPing"]);

    function takeChannelAndGetConnection(saga, isConnected) {
      return saga.next().call(_sagas.createIntervalChannel, 3000, _sagas.intervalChannelFn).next('channel').take('channel').next().select(_createReducer.networkSelector).next({
        isConnected: isConnected
      });
    }

    it("forks checkInternetAccessSaga if it's NOT connected or it is,\n     but pingOnlyIfOffline is false", function () {
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.connectionIntervalSaga, __assign(__assign({}, params), {
        pingOnlyIfOffline: false,
        pingInterval: 3000
      }));
      saga = takeChannelAndGetConnection(saga, true);
      saga.fork(_sagas.checkInternetAccessSaga, {
        pingTimeout: params.pingTimeout,
        pingServerUrl: params.pingServerUrl,
        httpMethod: params.httpMethod,
        pingInBackground: params.pingInBackground,
        customHeaders: args.customHeaders
      }).next().take('channel');
    });
    it("does NOT fork checkInternetAccessSaga if it's connected \n    AND pingOnlyIfOffline is true", function () {
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.connectionIntervalSaga, __assign(__assign({}, params), {
        pingOnlyIfOffline: true,
        pingInterval: 3000
      }));
      saga = takeChannelAndGetConnection(saga, true);
      saga.take('channel');
    });
    it('closes the channel when it ends emitting', function () {
      var mockCloseFn = jest.fn();
      var mockChannel = {
        close: mockCloseFn,
        isConnected: false,
        actionQueue: [],
        isQueuePaused: false
      };
      var iterator = (0, _sagas.connectionIntervalSaga)(__assign(__assign({}, params), {
        pingOnlyIfOffline: true,
        pingInterval: 3000
      }));
      iterator.next();
      iterator.next(mockChannel);

      try {
        iterator.next(true);
        expect(mockCloseFn).toHaveBeenCalled();
      } catch (e) {}
    });
    it('does NOT close the channel if redux-saga does NOT yield a cancelled effect', function () {
      var mockCloseFn = jest.fn();
      var mockChannel = {
        close: mockCloseFn,
        isConnected: false,
        actionQueue: [],
        isQueuePaused: false
      };
      var iterator = (0, _sagas.connectionIntervalSaga)(__assign(__assign({}, params), {
        pingOnlyIfOffline: true,
        pingInterval: 3000
      }));
      iterator.next();
      iterator.next(mockChannel);

      try {
        iterator.next(false);
        expect(mockCloseFn).not.toHaveBeenCalled();
      } catch (e) {}
    });
  });
  describe('checkInternetAccessSaga', function () {
    var params = {
      pingServerUrl: args.pingServerUrl,
      pingTimeout: args.pingTimeout,
      httpMethod: args.httpMethod,
      pingInBackground: false,
      customHeaders: args.customHeaders
    };
    it('returns early if pingInBackground is false AND app state is NOT active', function () {
      _reactNative.AppState.currentState = 'inactive';
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.checkInternetAccessSaga, params);
      saga.next().isDone();
    });
    it('calls checkInternetAccess AND handleConnectivityChange', function () {
      params.pingInBackground = true;
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.checkInternetAccessSaga, params);
      saga.next().call(_checkInternetAccess.default, {
        url: params.pingServerUrl,
        timeout: params.pingTimeout,
        method: params.httpMethod,
        customHeaders: params.customHeaders
      }).next(true).call(_sagas.handleConnectivityChange, true).next().isDone();
    });
  });
  describe('handleConnectivityChange', function () {
    it('dispatches a CONNECTION_CHANGE action if the connection changed ', function () {
      var actionQueue = ['foo', 'bar'];
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.handleConnectivityChange, false);
      saga.next().select(_createReducer.networkSelector).next({
        actionQueue: actionQueue,
        isConnected: true
      }).put((0, _actionCreators.connectionChange)(false)).next().isDone();
    });
    it('does NOT dispatch if connection did NOT change and we are offline', function () {
      var actionQueue = ['foo', 'bar'];
      var saga = (0, _reduxSagaTestPlan.testSaga)(_sagas.handleConnectivityChange, false);
      saga.next().select(_createReducer.networkSelector).next({
        actionQueue: actionQueue,
        isConnected: false
      }).isDone();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9EZXZBQy9EZXNrdG9wL0FuZ2F6YS9yZWFjdC1vZmZsaW5lLXN5bmMvc3JjL3Rlc3Qvc2FnYXMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0E7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBV0E7O0FBRUE7O0FBRUE7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNLElBQUksR0FBRyx1QkFBYjtBQUVBLFFBQVEsQ0FBQyxPQUFELEVBQVUsWUFBQTtBQUNoQixFQUFBLFFBQVEsQ0FBQyxhQUFELEVBQWdCLFlBQUE7QUFDdEIsSUFBQSxFQUFFLENBQUMsK0NBQUQsRUFBa0QsWUFBQTtBQUMxQyxVQUFBLFlBQUEsR0FBQSxJQUFBLENBQUEsWUFBQTtBQUFBLFVBQWMsTUFBQSxHQUFBLE1BQUEsQ0FBQSxJQUFBLEVBQUEsQ0FBQSxjQUFBLENBQUEsQ0FBZDs7QUFDQSxVQUFBLGdCQUFBLEdBQUEsTUFBQSxDQUFBLGdCQUFBO0FBQUEsVUFBa0IsaUJBQUEsR0FBQSxNQUFBLENBQUEsaUJBQWxCO0FBQUEsVUFBcUMsSUFBQSxHQUFBLE1BQUEsQ0FBQSxNQUFBLEVBQUEsQ0FBQSxrQkFBQSxFQUFBLG1CQUFBLENBQUEsQ0FBckM7O0FBQ1IsdUNBQVMsY0FBVCxFQUFzQixNQUF0QixFQUNHLElBREgsR0FFRyxJQUZILENBRVEsd0JBRlIsRUFFMkIsSUFGM0IsRUFHRyxJQUhILEdBSUcsTUFKSDtBQUtELEtBUkMsQ0FBRjtBQVVBLElBQUEsRUFBRSxDQUFDLHFGQUFELEVBQ2lDLFlBQUE7QUFDekIsVUFBQSxZQUFBLEdBQUEsSUFBQSxDQUFBLFlBQUE7QUFBQSxVQUFjLE1BQUEsR0FBQSxNQUFBLENBQUEsSUFBQSxFQUFBLENBQUEsY0FBQSxDQUFBLENBQWQ7O0FBRU4sVUFBQSxnQkFBQSxHQUFBLE1BQUEsQ0FBQSxnQkFBQTtBQUFBLFVBQ0EsaUJBQUEsR0FBQSxNQUFBLENBQUEsaUJBREE7QUFBQSxV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SCxHQU1HLE1BTkg7QUFPRCxLQVhDLENBQUY7QUFhQSxJQUFBLEVBQUUsQ0FBQyxtRUFBRCxFQUFzRSxZQUFBO0FBQ3RFLFVBQU0sV0FBVyxHQUFHLENBQUMsS0FBRCxFQUFRLEtBQVIsQ0FBcEI7QUFFQSxVQUFNLElBQUksR0FBRyxpQ0FBUywrQkFBVCxFQUFtQyxLQUFuQyxDQUFiO0FBQ0EsTUFBQSxJQUFJLENBQ0QsSUFESCxHQUVHLE1BRkgsQ0FFVSw4QkFGVixFQUdHLElBSEgsQ0FHUTtBQUFFLFFBQUEsV0FBVyxFQUFBLFdBQWI7QUFBZSxRQUFBLFdBQVcsRUFBRTtBQUE1QixPQUhSLEVBSUcsTUFKSDtBQUtELEtBVEMsQ0FBRjtBQVVELEdBeEJPLENBQVI7QUF5QkQsQ0FuVU8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5pbXBvcnQge1xuICB0ZXN0U2FnYSxcbiAgVGVzdEFwaSxcbiAgVGVzdEFwaVdpdGhFZmZlY3RzVGVzdGVycyxcbn0gZnJvbSAncmVkdXgtc2FnYS10ZXN0LXBsYW4nO1xuaW1wb3J0IHsgUGxhdGZvcm0sIEFwcFN0YXRlIH0gZnJvbSAncmVhY3QtbmF0aXZlJztcbmltcG9ydCBOZXRJbmZvLCB7IE5ldEluZm9TdGF0ZSB9IGZyb20gJ0ByZWFjdC1uYXRpdmUtY29tbXVuaXR5L25ldGluZm8nO1xuaW1wb3J0IG5ldHdvcmtTYWdhLCB7XG4gIG5ldEluZm9DaGFuZ2VTYWdhLFxuICBjb25uZWN0aW9uSW50ZXJ2YWxTYWdhLFxuICBjcmVhdGVOZXRJbmZvQ29ubmVjdGlvbkNoYW5nZUNoYW5uZWwsXG4gIGNvbm5lY3Rpb25IYW5kbGVyLFxuICBjaGVja0ludGVybmV0QWNjZXNzU2FnYSxcbiAgaGFuZGxlQ29ubmVjdGl2aXR5Q2hhbmdlLFxuICBjcmVhdGVJbnRlcnZhbENoYW5uZWwsXG4gIGludGVydmFsQ2hhbm5lbEZuLFxuICBuZXRJbmZvRXZlbnRDaGFubmVsRm4sXG59IGZyb20gJy4uL3NyYy9yZWR1eC9zYWdhcyc7XG5pbXBvcnQgeyBjb25uZWN0aW9uQ2hhbmdlIH0gZnJvbSAnLi4vc3JjL3JlZHV4L2FjdGlvbkNyZWF0b3JzJztcblxuaW1wb3J0IHsgbmV0d29ya1NlbGVjdG9yIH0gZnJvbSAnLi4vc3JjL3JlZHV4L2NyZWF0ZVJlZHVjZXInO1xuXG5pbXBvcnQgY2hlY2tJbnRlcm5ldEFjY2VzcyBmcm9tICcuLi9zcmMvdXRpbHMvY2hlY2tJbnRlcm5ldEFjY2Vzcyc7XG5pbXBvcnQgeyBERUZBVUxUX0FSR1MgfSBmcm9tICcuLi9zcmMvdXRpbHMvY29uc3RhbnRzJztcblxuY29uc3QgYXJncyA9IERFRkFVTFRfQVJHUztcblxuZGVzY3JpYmUoJ3NhZ2FzJywgKCkgPT4ge1xuICBkZXNjcmliZSgnbmV0d29ya1NhZ2EnLCAoKSA9PiB7XG4gICAgaXQoJ2ZvcmtzIG5ldEluZm9DaGFuZ2VTYWdhIHdpdGggdGhlIHJpZ2h0IHBhcmFtcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcGluZ0ludGVydmFsLCAuLi5wYXJhbXMgfSA9IGFyZ3M7XG4gICAgICBjb25zdCB7IHBpbmdJbkJhY2tncm91bmQsIHBpbmdPbmx5SWZPZmZsaW5lLCAuLi5yZXN0IH0gPSBwYXJhbXM7XG4gICAgICB0ZXN0U2FnYShuZXR3b3JrU2FnYSwgcGFyYW1zKVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5mb3JrKG5ldEluZm9DaGFuZ2VTYWdhLCByZXN0KVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5pc0RvbmUoKTtcbiAgICB9KTtcblxuICAgIGl0KGBmb3JrcyBuZXRJbmZvQ2hhbmdlU2FnYSBBTkQgc2V0cyBhbiBpbnRlcnZhbCBcbiAgICBpZiBwaW5nSW50ZXJ2YWwgaXMgaGlnaGVyIHRoYW4gMGAsICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcGluZ0ludGVydmFsLCAuLi5wYXJhbXMgfSA9IGFyZ3M7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHBpbmdJbkJhY2tncm91bmQsXG4gICAgICAgIHBpbmdPbmx5SWZPZmZsaW5lLFxuICAgICAgICBzaG91bGRQaW5nLFxuICAgICAgICAuLi5yZXN0XG4gICAgICB9ID0gcGFyYW1zO1xuICAgICAgdGVzdFNhZ2EobmV0d29ya1NhZ2EsIHsgLi4uYXJncywgcGluZ0ludGVydmFsOiAzMDAwIH0pXG4gICAgICAgIC5uZXh0KClcbiAgICAgICAgLmZvcmsobmV0SW5mb0NoYW5nZVNhZ2EsIHsgLi4ucmVzdCwgc2hvdWxkUGluZyB9KVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5mb3JrKGNvbm5lY3Rpb25JbnRlcnZhbFNhZ2EsIHtcbiAgICAgICAgICAuLi5yZXN0LFxuICAgICAgICAgIHBpbmdJbnRlcnZhbDogMzAwMCxcbiAgICAgICAgICBwaW5nT25seUlmT2ZmbGluZSxcbiAgICAgICAgICBwaW5nSW5CYWNrZ3JvdW5kLFxuICAgICAgICB9KVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5pc0RvbmUoKTtcbiAgICB9KTtcblxuICAgIGl0KCdkZWZhdWx0IHBhcmFtZXRlcnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHBpbmdPbmx5SWZPZmZsaW5lLFxuICAgICAgICBwaW5nSW50ZXJ2YWwsXG4gICAgICAgIHBpbmdJbkJhY2tncm91bmQsXG4gICAgICAgIC4uLnBhcmFtc1xuICAgICAgfSA9IGFyZ3M7XG4gICAgICB0ZXN0U2FnYShuZXR3b3JrU2FnYSlcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuZm9yayhuZXRJbmZvQ2hhbmdlU2FnYSwgeyAuLi5wYXJhbXMgfSlcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuaXNEb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCduZXRJbmZvQ2hhbmdlU2FnYScsICgpID0+IHtcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBwaW5nVGltZW91dDogYXJncy5waW5nVGltZW91dCxcbiAgICAgIHBpbmdTZXJ2ZXJVcmw6IGFyZ3MucGluZ1NlcnZlclVybCxcbiAgICAgIHNob3VsZFBpbmc6IGFyZ3Muc2hvdWxkUGluZyxcbiAgICAgIGh0dHBNZXRob2Q6IGFyZ3MuaHR0cE1ldGhvZCxcbiAgICAgIGN1c3RvbUhlYWRlcnM6IGFyZ3MuY3VzdG9tSGVhZGVycyxcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGNoYW5uZWxMb29wKHNhZ2E6IFRlc3RBcGkpIHtcbiAgICAgIHJldHVybiBzYWdhXG4gICAgICAgIC5uZXh0KClcbiAgICAgICAgLmNhbGwoY3JlYXRlTmV0SW5mb0Nvbm5lY3Rpb25DaGFuZ2VDaGFubmVsLCBuZXRJbmZvRXZlbnRDaGFubmVsRm4pXG4gICAgICAgIC5uZXh0KCdjaGFubmVsJylcbiAgICAgICAgLnRha2UoJ2NoYW5uZWwnKVxuICAgICAgICAubmV4dCh0cnVlKVxuICAgICAgICAuZm9yayhjb25uZWN0aW9uSGFuZGxlciwge1xuICAgICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgICBpc0Nvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAudGFrZSgnY2hhbm5lbCcpO1xuICAgIH1cbiAgICBpdCgnaU9TJywgKCkgPT4ge1xuICAgICAgUGxhdGZvcm0uT1MgPSAnaW9zJztcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IHNhZ2EgPSB0ZXN0U2FnYShuZXRJbmZvQ2hhbmdlU2FnYSwgcGFyYW1zKTtcbiAgICAgIGNoYW5uZWxMb29wKHNhZ2EpO1xuICAgIH0pO1xuXG4gICAgaXQoJ0FuZHJvaWQnLCAoKSA9PiB7XG4gICAgICBQbGF0Zm9ybS5PUyA9ICdhbmRyb2lkJztcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IHNhZ2EgPSB0ZXN0U2FnYShuZXRJbmZvQ2hhbmdlU2FnYSwgcGFyYW1zKVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5jYWxsKFtOZXRJbmZvLCBOZXRJbmZvLmZldGNoXSlcbiAgICAgICAgLm5leHQoeyBpc0Nvbm5lY3RlZDogZmFsc2UgfSlcbiAgICAgICAgLmZvcmsoY29ubmVjdGlvbkhhbmRsZXIsIHtcbiAgICAgICAgICAuLi5wYXJhbXMsXG4gICAgICAgICAgaXNDb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgIGNoYW5uZWxMb29wKHNhZ2EpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2Nsb3NlcyB0aGUgY2hhbm5lbCB3aGVuIGl0IGVuZHMgZW1pdHRpbmcnLCAoKSA9PiB7XG4gICAgICBQbGF0Zm9ybS5PUyA9ICdpb3MnO1xuICAgICAgY29uc3QgbW9ja0Nsb3NlRm4gPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCBtb2NrQ2hhbm5lbCA9IHtcbiAgICAgICAgY2xvc2U6IG1vY2tDbG9zZUZuLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgaXRlcmF0b3IgPSBuZXRJbmZvQ2hhbmdlU2FnYShwYXJhbXMpO1xuICAgICAgaXRlcmF0b3IubmV4dCgpO1xuICAgICAgLy8gVGhpcyB3aWxsIG1ha2UgdGFrZShtb2NrQ2hhbm5lbCkgdGhyb3cgYW4gZXJyb3IsIHNpbmNlIGl0J3Mgbm90IGEgdmFsaWRcbiAgICAgIC8vIGNoYW5uZWwgb3IgYSB2YWxpZCBwYXR0ZXJuIGZvciB0YWtlKCkgaW5zaWRlIHRoZSBpbmZpbml0ZSBsb29wLFxuICAgICAgLy8gaGVuY2UgZXhlY3V0aW5nIHRoZSBmaW5hbGx5IGJsb2NrLlxuICAgICAgaXRlcmF0b3IubmV4dCgobW9ja0NoYW5uZWwgYXMgdW5rbm93bikgYXMgTmV0SW5mb1N0YXRlKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGl0ZXJhdG9yLm5leHQoeyBpc0Nvbm5lY3RlZDogdHJ1ZSB9IGFzIE5ldEluZm9TdGF0ZSk7XG4gICAgICAgIGV4cGVjdChtb2NrQ2xvc2VGbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmVcbiAgICAgIH0gY2F0Y2ggKGUpIHt9XG4gICAgfSk7XG5cbiAgICBpdCgnZG9lcyBOT1QgY2xvc2UgdGhlIGNoYW5uZWwgaWYgcmVkdXgtc2FnYSBkb2VzIE5PVCB5aWVsZCBhIGNhbmNlbGxlZCBlZmZlY3QnLCAoKSA9PiB7XG4gICAgICBQbGF0Zm9ybS5PUyA9ICdpb3MnO1xuICAgICAgY29uc3QgbW9ja0Nsb3NlRm4gPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCBtb2NrQ2hhbm5lbCA9IHtcbiAgICAgICAgY2xvc2U6IG1vY2tDbG9zZUZuLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgaXRlcmF0b3IgPSBuZXRJbmZvQ2hhbmdlU2FnYShwYXJhbXMpO1xuICAgICAgaXRlcmF0b3IubmV4dCgpO1xuICAgICAgLy8gVGhpcyB3aWxsIG1ha2UgdGFrZShtb2NrQ2hhbm5lbCkgdGhyb3cgYW4gZXJyb3IsIHNpbmNlIGl0J3Mgbm90IGEgdmFsaWRcbiAgICAgIC8vIGNoYW5uZWwgb3IgYSB2YWxpZCBwYXR0ZXJuIGZvciB0YWtlKCkgaW5zaWRlIHRoZSBpbmZpbml0ZSBsb29wLFxuICAgICAgLy8gaGVuY2UgZXhlY3V0aW5nIHRoZSBmaW5hbGx5IGJsb2NrLlxuICAgICAgaXRlcmF0b3IubmV4dCgobW9ja0NoYW5uZWwgYXMgdW5rbm93bikgYXMgTmV0SW5mb1N0YXRlKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGl0ZXJhdG9yLm5leHQoeyBpc0Nvbm5lY3RlZDogZmFsc2UgfSBhcyBOZXRJbmZvU3RhdGUpO1xuICAgICAgICBleHBlY3QobW9ja0Nsb3NlRm4pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgICAgfSBjYXRjaCAoZSkge31cbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Nvbm5lY3Rpb25IYW5kbGVyJywgKCkgPT4ge1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIHBpbmdUaW1lb3V0OiBhcmdzLnBpbmdUaW1lb3V0LFxuICAgICAgcGluZ1NlcnZlclVybDogYXJncy5waW5nU2VydmVyVXJsLFxuICAgICAgc2hvdWxkUGluZzogdHJ1ZSxcbiAgICAgIGh0dHBNZXRob2Q6IGFyZ3MuaHR0cE1ldGhvZCxcbiAgICAgIGlzQ29ubmVjdGVkOiB0cnVlLFxuICAgICAgY3VzdG9tSGVhZGVyczogYXJncy5jdXN0b21IZWFkZXJzLFxuICAgIH07XG4gICAgaXQoJ2ZvcmtzIGNoZWNrSW50ZXJuZXRBY2Nlc3NTYWdhIGlmIHNob3VsZFBpbmcgQU5EIGlzQ29ubmVjdGVkIGFyZSB0cnVlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2FnYSA9IHRlc3RTYWdhKGNvbm5lY3Rpb25IYW5kbGVyLCBwYXJhbXMpO1xuICAgICAgc2FnYVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5mb3JrKGNoZWNrSW50ZXJuZXRBY2Nlc3NTYWdhLCB7XG4gICAgICAgICAgcGluZ1RpbWVvdXQ6IGFyZ3MucGluZ1RpbWVvdXQsXG4gICAgICAgICAgcGluZ1NlcnZlclVybDogYXJncy5waW5nU2VydmVyVXJsLFxuICAgICAgICAgIGh0dHBNZXRob2Q6IGFyZ3MuaHR0cE1ldGhvZCxcbiAgICAgICAgICBwaW5nSW5CYWNrZ3JvdW5kOiBhcmdzLnBpbmdJbkJhY2tncm91bmQsXG4gICAgICAgICAgY3VzdG9tSGVhZGVyczogYXJncy5jdXN0b21IZWFkZXJzLFxuICAgICAgICB9KVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5pc0RvbmUoKTtcbiAgICB9KTtcbiAgICBpdCgnZm9ya3MgaGFuZGxlQ29ubmVjdGl2aXR5Q2hhbmdlIGlmIHNob3VsZFBpbmcgT1IgaXNDb25uZWN0ZWQgYXJlIE5PVCB0cnVlJywgKCkgPT4ge1xuICAgICAgcGFyYW1zLmlzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgICBjb25zdCBzYWdhID0gdGVzdFNhZ2EoY29ubmVjdGlvbkhhbmRsZXIsIHBhcmFtcyk7XG4gICAgICBzYWdhXG4gICAgICAgIC5uZXh0KClcbiAgICAgICAgLmZvcmsoaGFuZGxlQ29ubmVjdGl2aXR5Q2hhbmdlLCBmYWxzZSlcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuaXNEb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjb25uZWN0aW9uSW50ZXJ2YWxTYWdhJywgKCkgPT4ge1xuICAgIGNvbnN0IHsgc2hvdWxkUGluZywgLi4ucGFyYW1zIH0gPSBhcmdzO1xuICAgIGZ1bmN0aW9uIHRha2VDaGFubmVsQW5kR2V0Q29ubmVjdGlvbihzYWdhOiBUZXN0QXBpLCBpc0Nvbm5lY3RlZDogYm9vbGVhbikge1xuICAgICAgcmV0dXJuIHNhZ2FcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuY2FsbChjcmVhdGVJbnRlcnZhbENoYW5uZWwsIDMwMDAsIGludGVydmFsQ2hhbm5lbEZuKVxuICAgICAgICAubmV4dCgnY2hhbm5lbCcpXG4gICAgICAgIC50YWtlKCdjaGFubmVsJylcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuc2VsZWN0KG5ldHdvcmtTZWxlY3RvcilcbiAgICAgICAgLm5leHQoeyBpc0Nvbm5lY3RlZCB9KTtcbiAgICB9XG4gICAgaXQoYGZvcmtzIGNoZWNrSW50ZXJuZXRBY2Nlc3NTYWdhIGlmIGl0J3MgTk9UIGNvbm5lY3RlZCBvciBpdCBpcyxcbiAgICAgYnV0IHBpbmdPbmx5SWZPZmZsaW5lIGlzIGZhbHNlYCwgKCkgPT4ge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgbGV0IHNhZ2E6IFRlc3RBcGlXaXRoRWZmZWN0c1Rlc3RlcnMgPSB0ZXN0U2FnYShjb25uZWN0aW9uSW50ZXJ2YWxTYWdhLCB7XG4gICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgcGluZ09ubHlJZk9mZmxpbmU6IGZhbHNlLFxuICAgICAgICBwaW5nSW50ZXJ2YWw6IDMwMDAsXG4gICAgICB9KTtcbiAgICAgIHNhZ2EgPSB0YWtlQ2hhbm5lbEFuZEdldENvbm5lY3Rpb24oc2FnYSwgdHJ1ZSk7XG4gICAgICBzYWdhXG4gICAgICAgIC5mb3JrKGNoZWNrSW50ZXJuZXRBY2Nlc3NTYWdhLCB7XG4gICAgICAgICAgcGluZ1RpbWVvdXQ6IHBhcmFtcy5waW5nVGltZW91dCxcbiAgICAgICAgICBwaW5nU2VydmVyVXJsOiBwYXJhbXMucGluZ1NlcnZlclVybCxcbiAgICAgICAgICBodHRwTWV0aG9kOiBwYXJhbXMuaHR0cE1ldGhvZCxcbiAgICAgICAgICBwaW5nSW5CYWNrZ3JvdW5kOiBwYXJhbXMucGluZ0luQmFja2dyb3VuZCxcbiAgICAgICAgICBjdXN0b21IZWFkZXJzOiBhcmdzLmN1c3RvbUhlYWRlcnMsXG4gICAgICAgIH0pXG4gICAgICAgIC5uZXh0KClcbiAgICAgICAgLnRha2UoJ2NoYW5uZWwnKTtcbiAgICB9KTtcblxuICAgIGl0KGBkb2VzIE5PVCBmb3JrIGNoZWNrSW50ZXJuZXRBY2Nlc3NTYWdhIGlmIGl0J3MgY29ubmVjdGVkIFxuICAgIEFORCBwaW5nT25seUlmT2ZmbGluZSBpcyB0cnVlYCwgKCkgPT4ge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgbGV0IHNhZ2E6IFRlc3RBcGlXaXRoRWZmZWN0c1Rlc3RlcnMgPSB0ZXN0U2FnYShjb25uZWN0aW9uSW50ZXJ2YWxTYWdhLCB7XG4gICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgcGluZ09ubHlJZk9mZmxpbmU6IHRydWUsXG4gICAgICAgIHBpbmdJbnRlcnZhbDogMzAwMCxcbiAgICAgIH0pO1xuICAgICAgc2FnYSA9IHRha2VDaGFubmVsQW5kR2V0Q29ubmVjdGlvbihzYWdhLCB0cnVlKTtcbiAgICAgIHNhZ2EudGFrZSgnY2hhbm5lbCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2Nsb3NlcyB0aGUgY2hhbm5lbCB3aGVuIGl0IGVuZHMgZW1pdHRpbmcnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQ2xvc2VGbiA9IGplc3QuZm4oKTtcbiAgICAgIGNvbnN0IG1vY2tDaGFubmVsID0ge1xuICAgICAgICBjbG9zZTogbW9ja0Nsb3NlRm4sXG4gICAgICAgIGlzQ29ubmVjdGVkOiBmYWxzZSxcbiAgICAgICAgYWN0aW9uUXVldWU6IFtdLFxuICAgICAgICBpc1F1ZXVlUGF1c2VkOiBmYWxzZSxcbiAgICAgIH07XG4gICAgICBjb25zdCBpdGVyYXRvciA9IGNvbm5lY3Rpb25JbnRlcnZhbFNhZ2Eoe1xuICAgICAgICAuLi5wYXJhbXMsXG4gICAgICAgIHBpbmdPbmx5SWZPZmZsaW5lOiB0cnVlLFxuICAgICAgICBwaW5nSW50ZXJ2YWw6IDMwMDAsXG4gICAgICB9KTtcbiAgICAgIGl0ZXJhdG9yLm5leHQoKTtcbiAgICAgIC8vIFRoaXMgd2lsbCBtYWtlIHRha2UobW9ja0NoYW5uZWwpIHRocm93IGFuIGVycm9yLCBzaW5jZSBpdCdzIG5vdCBhIHZhbGlkXG4gICAgICAvLyBjaGFubmVsIG9yIGEgdmFsaWQgcGF0dGVybiBmb3IgdGFrZSgpIGluc2lkZSB0aGUgaW5maW5pdGUgbG9vcCxcbiAgICAgIC8vIGhlbmNlIGV4ZWN1dGluZyB0aGUgZmluYWxseSBibG9jay5cbiAgICAgIGl0ZXJhdG9yLm5leHQobW9ja0NoYW5uZWwpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpdGVyYXRvci5uZXh0KHRydWUpO1xuICAgICAgICBleHBlY3QobW9ja0Nsb3NlRm4pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG4gICAgICB9IGNhdGNoIChlKSB7fVxuICAgIH0pO1xuXG4gICAgaXQoJ2RvZXMgTk9UIGNsb3NlIHRoZSBjaGFubmVsIGlmIHJlZHV4LXNhZ2EgZG9lcyBOT1QgeWllbGQgYSBjYW5jZWxsZWQgZWZmZWN0JywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0Nsb3NlRm4gPSBqZXN0LmZuKCk7XG4gICAgICBjb25zdCBtb2NrQ2hhbm5lbCA9IHtcbiAgICAgICAgY2xvc2U6IG1vY2tDbG9zZUZuLFxuICAgICAgICBpc0Nvbm5lY3RlZDogZmFsc2UsXG4gICAgICAgIGFjdGlvblF1ZXVlOiBbXSxcbiAgICAgICAgaXNRdWV1ZVBhdXNlZDogZmFsc2UsXG4gICAgICB9O1xuICAgICAgY29uc3QgaXRlcmF0b3IgPSBjb25uZWN0aW9uSW50ZXJ2YWxTYWdhKHtcbiAgICAgICAgLi4ucGFyYW1zLFxuICAgICAgICBwaW5nT25seUlmT2ZmbGluZTogdHJ1ZSxcbiAgICAgICAgcGluZ0ludGVydmFsOiAzMDAwLFxuICAgICAgfSk7XG4gICAgICBpdGVyYXRvci5uZXh0KCk7XG4gICAgICAvLyBUaGlzIHdpbGwgbWFrZSB0YWtlKG1vY2tDaGFubmVsKSB0aHJvdyBhbiBlcnJvciwgc2luY2UgaXQncyBub3QgYSB2YWxpZFxuICAgICAgLy8gY2hhbm5lbCBvciBhIHZhbGlkIHBhdHRlcm4gZm9yIHRha2UoKSBpbnNpZGUgdGhlIGluZmluaXRlIGxvb3AsXG4gICAgICAvLyBoZW5jZSBleGVjdXRpbmcgdGhlIGZpbmFsbHkgYmxvY2suXG4gICAgICBpdGVyYXRvci5uZXh0KG1vY2tDaGFubmVsKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaXRlcmF0b3IubmV4dChmYWxzZSk7XG4gICAgICAgIGV4cGVjdChtb2NrQ2xvc2VGbikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG4gICAgICB9IGNhdGNoIChlKSB7fVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2hlY2tJbnRlcm5ldEFjY2Vzc1NhZ2EnLCAoKSA9PiB7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgcGluZ1NlcnZlclVybDogYXJncy5waW5nU2VydmVyVXJsLFxuICAgICAgcGluZ1RpbWVvdXQ6IGFyZ3MucGluZ1RpbWVvdXQsXG4gICAgICBodHRwTWV0aG9kOiBhcmdzLmh0dHBNZXRob2QsXG4gICAgICBwaW5nSW5CYWNrZ3JvdW5kOiBmYWxzZSxcbiAgICAgIGN1c3RvbUhlYWRlcnM6IGFyZ3MuY3VzdG9tSGVhZGVycyxcbiAgICB9O1xuICAgIGl0KCdyZXR1cm5zIGVhcmx5IGlmIHBpbmdJbkJhY2tncm91bmQgaXMgZmFsc2UgQU5EIGFwcCBzdGF0ZSBpcyBOT1QgYWN0aXZlJywgKCkgPT4ge1xuICAgICAgQXBwU3RhdGUuY3VycmVudFN0YXRlID0gJ2luYWN0aXZlJztcbiAgICAgIGNvbnN0IHNhZ2EgPSB0ZXN0U2FnYShjaGVja0ludGVybmV0QWNjZXNzU2FnYSwgcGFyYW1zKTtcbiAgICAgIHNhZ2EubmV4dCgpLmlzRG9uZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2NhbGxzIGNoZWNrSW50ZXJuZXRBY2Nlc3MgQU5EIGhhbmRsZUNvbm5lY3Rpdml0eUNoYW5nZScsICgpID0+IHtcbiAgICAgIHBhcmFtcy5waW5nSW5CYWNrZ3JvdW5kID0gdHJ1ZTtcbiAgICAgIGNvbnN0IHNhZ2EgPSB0ZXN0U2FnYShjaGVja0ludGVybmV0QWNjZXNzU2FnYSwgcGFyYW1zKTtcbiAgICAgIHNhZ2FcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuY2FsbChjaGVja0ludGVybmV0QWNjZXNzLCB7XG4gICAgICAgICAgdXJsOiBwYXJhbXMucGluZ1NlcnZlclVybCxcbiAgICAgICAgICB0aW1lb3V0OiBwYXJhbXMucGluZ1RpbWVvdXQsXG4gICAgICAgICAgbWV0aG9kOiBwYXJhbXMuaHR0cE1ldGhvZCxcbiAgICAgICAgICBjdXN0b21IZWFkZXJzOiBwYXJhbXMuY3VzdG9tSGVhZGVycyxcbiAgICAgICAgfSlcbiAgICAgICAgLm5leHQodHJ1ZSlcbiAgICAgICAgLmNhbGwoaGFuZGxlQ29ubmVjdGl2aXR5Q2hhbmdlLCB0cnVlKVxuICAgICAgICAubmV4dCgpXG4gICAgICAgIC5pc0RvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2hhbmRsZUNvbm5lY3Rpdml0eUNoYW5nZScsICgpID0+IHtcbiAgICBpdCgnZGlzcGF0Y2hlcyBhIENPTk5FQ1RJT05fQ0hBTkdFIGFjdGlvbiBpZiB0aGUgY29ubmVjdGlvbiBjaGFuZ2VkICcsICgpID0+IHtcbiAgICAgIGNvbnN0IGFjdGlvblF1ZXVlID0gWydmb28nLCAnYmFyJ107XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBjb25zdCBzYWdhID0gdGVzdFNhZ2EoaGFuZGxlQ29ubmVjdGl2aXR5Q2hhbmdlLCBmYWxzZSk7XG4gICAgICBzYWdhXG4gICAgICAgIC5uZXh0KClcbiAgICAgICAgLnNlbGVjdChuZXR3b3JrU2VsZWN0b3IpXG4gICAgICAgIC5uZXh0KHsgYWN0aW9uUXVldWUsIGlzQ29ubmVjdGVkOiB0cnVlIH0pXG4gICAgICAgIC5wdXQoY29ubmVjdGlvbkNoYW5nZShmYWxzZSkpXG4gICAgICAgIC5uZXh0KClcbiAgICAgICAgLmlzRG9uZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2RvZXMgTk9UIGRpc3BhdGNoIGlmIGNvbm5lY3Rpb24gZGlkIE5PVCBjaGFuZ2UgYW5kIHdlIGFyZSBvZmZsaW5lJywgKCkgPT4ge1xuICAgICAgY29uc3QgYWN0aW9uUXVldWUgPSBbJ2ZvbycsICdiYXInXTtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IHNhZ2EgPSB0ZXN0U2FnYShoYW5kbGVDb25uZWN0aXZpdHlDaGFuZ2UsIGZhbHNlKTtcbiAgICAgIHNhZ2FcbiAgICAgICAgLm5leHQoKVxuICAgICAgICAuc2VsZWN0KG5ldHdvcmtTZWxlY3RvcilcbiAgICAgICAgLm5leHQoeyBhY3Rpb25RdWV1ZSwgaXNDb25uZWN0ZWQ6IGZhbHNlIH0pXG4gICAgICAgIC5pc0RvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==